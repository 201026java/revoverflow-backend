<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>RSSService.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">revoverflow-backend (Jul 21, 2020 2:28:08 PM)</a> &gt; <a href="../../index.html" class="el_group">revoverflow-backend</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.revature.services</a> &gt; <span class="el_source">RSSService.java</span></div><h1>RSSService.java</h1><pre class="source lang-java linenums">package com.revature.services;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.revature.DTOs.RSSAccountDTO;
import com.revature.DTOs.RSSUserDTO;
import com.revature.entities.User;
import com.revature.repositories.UserRepository;
import com.revature.util.JwtUtil;

@Service
public class RSSService {
	
	
	@Autowired
	UserRepository userRepository;

	@Value(&quot;${environments.rss}&quot;)
	String rssServiceUrl;
	
	private RestTemplate restTemplate;
	
<span class="nc" id="L37">	public RSSService(RestTemplateBuilder restTemplateBuilder) {</span>
<span class="nc" id="L38">		this.restTemplate = restTemplateBuilder.build();</span>
<span class="nc" id="L39">	}</span>
	
	
	
	/**
	 * @Author Ryan Clayton
	 * @param u this takes in a RSSUserDto object with an email and password populated
	 * @return User this user is authenticated with the RSS account service
	 */
	public User login(RSSUserDTO u) {
		// create headers
<span class="nc" id="L50">	    HttpHeaders headers = new HttpHeaders();</span>
	    // set `content-type` header
<span class="nc" id="L52">	    headers.setContentType(MediaType.APPLICATION_JSON);</span>
	    // set `accept` header
<span class="nc" id="L54">	    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L55">	    String login = rssServiceUrl+&quot;/user/login/&quot;;</span>
		//create map for user login post parameters
<span class="nc" id="L57">		Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L58">		map.put(&quot;email&quot;, u.getEmail());</span>
<span class="nc" id="L59">		map.put(&quot;password&quot;, u.getPassword());</span>
		
		//build the request
<span class="nc" id="L62">		HttpEntity&lt;Map&lt;String,Object&gt;&gt; entity = new HttpEntity&lt;&gt;(map,headers);</span>
		
		//send Post Request
<span class="nc" id="L65">		ResponseEntity&lt;RSSUserDTO&gt; response= this.restTemplate.postForEntity(login, entity, RSSUserDTO.class);</span>
		
		//Begin building User object
<span class="nc" id="L68">		User user = new User();</span>
<span class="nc" id="L69">		user.setEmail(u.getEmail());</span>
		
<span class="nc bnc" id="L71" title="All 2 branches missed.">		if(response.hasBody()) {	</span>
			//continue building user from response body
<span class="nc" id="L73">			RSSUserDTO body = response.getBody();</span>
			
			
<span class="nc bnc" id="L76" title="All 2 branches missed.">			if(!userRepository.existsById(body.getUserId())) {</span>
<span class="nc" id="L77">				user.setAdmin(body.getAdmin());</span>
<span class="nc" id="L78">				user.setFirstName(body.getFirstName());</span>
<span class="nc" id="L79">				user.setLastName(body.getLastName());</span>
<span class="nc" id="L80">				user.setProfilePicture(body.getProfilePic());</span>
<span class="nc" id="L81">				user.setUserID(body.getUserId());</span>
				
				
				
<span class="nc" id="L85">				String newAcc = rssServiceUrl+&quot;/account/new&quot;;</span>
				//create map for new account post parameters
<span class="nc" id="L87">				map.clear();</span>
<span class="nc" id="L88">				map.put(&quot;userId&quot;,body.getUserId());</span>
<span class="nc" id="L89">				map.put(&quot;accTypeId&quot;,3);</span>
				
				//build the request
<span class="nc" id="L92">				entity = new HttpEntity&lt;&gt;(map,headers);</span>
				//send the request
<span class="nc" id="L94">				ResponseEntity&lt;RSSAccountDTO&gt; accResponse= this.restTemplate.postForEntity(newAcc, entity, RSSAccountDTO.class);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">				if(accResponse.hasBody()) {</span>
				
					//finish building user object
<span class="nc" id="L98">					RSSAccountDTO accBody = accResponse.getBody();</span>
<span class="nc" id="L99">					user.setRSSAccountId(accBody.getAccId());</span>
<span class="nc" id="L100">					user.setPoints(accBody.getPoints());</span>
				
				}
				//create jwt for user
<span class="nc" id="L104">				JwtUtil jwt = new JwtUtil();</span>
<span class="nc" id="L105">				user.setJwt(jwt.generateToken(user));</span>
				
<span class="nc" id="L107">			}else {</span>
<span class="nc" id="L108">				Optional&lt;User&gt; optUser = userRepository.findById(body.getUserId());</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				if (optUser.isPresent()) {</span>
					//get user data from our database
<span class="nc" id="L111">					user = optUser.get();</span>
					
<span class="nc" id="L113">					String getPoints = rssServiceUrl+&quot;/account/account&quot;;</span>
					//create url for rss points request
					//create map for new account post parameters
<span class="nc" id="L116">					map.clear();</span>
<span class="nc" id="L117">					map.put(&quot;userId&quot;,user.getUserID());</span>
<span class="nc" id="L118">					map.put(&quot;accId&quot;,user.getRSSAccountId());</span>
					
					//build the request
<span class="nc" id="L121">					entity = new HttpEntity&lt;&gt;(map,headers);</span>
				
					//send the request
<span class="nc" id="L124">					ResponseEntity&lt;RSSAccountDTO&gt; accResponse= this.restTemplate.postForEntity(getPoints, entity, RSSAccountDTO.class);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">					if(accResponse.hasBody()) {</span>
<span class="nc" id="L126">						user.setPoints(accResponse.getBody().getPoints());</span>
					}
					//create jwt token for our user
<span class="nc" id="L129">					JwtUtil jwt = new JwtUtil();</span>
<span class="nc" id="L130">					user.setJwt(jwt.generateToken(user));</span>

				}
			}
			
<span class="nc" id="L135">			return userRepository.save(user);</span>
		}		
		else {
<span class="nc" id="L138">			return null;</span>
		}
	}

	/**
	 * @Author Kei
	 * @param id  this is the user's id number
	 * @return the number of points in a user's RSS account from the RSS account service
	 */
	public int getPoints(int id) {
<span class="nc" id="L148">		HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L149">	    headers.setContentType(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L150">	    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L151">	    String getPoints = rssServiceUrl+&quot;/account/account&quot;;</span>

<span class="nc" id="L153">	    Optional&lt;User&gt; optUser = userRepository.findById(id);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">	    if (optUser.isPresent()) {</span>
<span class="nc" id="L155">	    	User user = optUser.get();</span>
	    
<span class="nc" id="L157">	    	Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L158">	    	map.put(&quot;accId&quot;, user.getRSSAccountId());</span>
	    	
<span class="nc" id="L160">	    	HttpEntity&lt;Map&lt;String,Object&gt;&gt; entity = new HttpEntity&lt;&gt;(map,headers);</span>
	    	
<span class="nc" id="L162">	    	ResponseEntity&lt;RSSAccountDTO&gt; response= this.restTemplate.postForEntity(getPoints, entity, RSSAccountDTO.class);</span>
	    	
<span class="nc" id="L164">	    	RSSAccountDTO account = response.getBody();</span>
<span class="nc" id="L165">	    	return account.getPoints();</span>
	    }else {
<span class="nc" id="L167">	    	return 0;</span>
	    }

	}


	/**
	 * @Author Haji
	 * @param acc  this takes in an RSSAccountDTO object with the userId and the number of points populated
	 * @return the user with an updated number of points in both from our database as well as the RSS account service DB
	 */

	public User addPoints(RSSAccountDTO acc) {
<span class="nc" id="L180">		 	HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L181">		    headers.setContentType(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L182">		    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L183">		    Optional&lt;User&gt; optUser = userRepository.findById(acc.getUserId());</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">		    if (optUser.isPresent()) {</span>
<span class="nc" id="L185">		    	User user = optUser.get();</span>
		    	
<span class="nc" id="L187">		    	String addPoints = rssServiceUrl+&quot;/account/points/a&quot;;</span>
<span class="nc" id="L188">		    	Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L189">		    	map.put(&quot;accId&quot;, user.getRSSAccountId());</span>
<span class="nc" id="L190">		    	map.put(&quot;points&quot;, acc.getPoints());</span>
		    	
<span class="nc" id="L192">		    	HttpEntity&lt;Map&lt;String,Object&gt;&gt; entity = new HttpEntity&lt;&gt;(map,headers);</span>
		    	
<span class="nc" id="L194">		    	ResponseEntity&lt;RSSAccountDTO&gt; response= this.restTemplate.postForEntity(addPoints, entity, RSSAccountDTO.class);</span>
		    	
<span class="nc bnc" id="L196" title="All 2 branches missed.">				if(response.getStatusCode()==HttpStatus.OK) {</span>
<span class="nc" id="L197">					user.setPoints(user.getPoints()+acc.getPoints());</span>
<span class="nc" id="L198">					return userRepository.save(user);</span>
				}
				else {
<span class="nc" id="L201">					return null;</span>
				}
		    }
		    else {
<span class="nc" id="L205">		    	return null;</span>
		    }

	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span>revoverflow-backend (Jul 21, 2020 2:28:08 PM)</div></body></html>